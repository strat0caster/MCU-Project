C51 COMPILER V9.54   MAIN                                                                  01/08/2016 22:25:18 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\main.c COMPACT OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Li
                    -stings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #define D_Round 0.2  
   2          #define pi 3.14159265358
   3          #define distance_1 20
   4          #define distance_2 40
   5          #define distance_3 60
   6          #define thres_omega 6553
   7          #define thres_turning 562500
   8          #define omega_acc 900 //快速加速阈值 
   9          
  10          #include "lights.h"
  11          
  12          
  13          unsigned char counter=0;
  14          int Receive_Buff[11];
  15          int a[3],w[3],Angle[3];
  16          int a1=0,a2=0,a3=0;
  17          int w1=0,w2=0;
  18          float w_turning;
  19          
  20          int Dist=0;
  21          double AngleNew=0;
  22          bit dis_flag_1=0,dis_flag_2=0,dis_flag_3=0;
  23          bit Flag=0;
  24          
  25          int main(){
  26   1      
  27   1        
  28   1        UartInit();
  29   1      
  30   1        while(1){                                          //20ms
  31   2      
  32   2              w_turning=(w[0]*w[0]+w[2]*w[2]);                            //用于转向判断
  33   2              if(w_turning>thres_turning) {turning_pattern();}
  34   2              else if(w2-w1>omega_acc)  {speeding_pattern();}//omega_acc为快速加速阈值
  35   2              else if(w1-w2>omega_acc)  {slowing_pattern();}//omega_slow为刹车阈值
  36   2              else if(dis_flag_1){display_distance(1);}
  37   2              else if(dis_flag_2){display_distance(2);}
  38   2              else if(dis_flag_3){display_distance(3);}
  39   2              else{cruise_pattern();}
  40   2              
  41   2              if(Dist==distance_1){dis_flag_1=1;};
  42   2              if(Dist==distance_2){dis_flag_2=1;};
  43   2              if(Dist==distance_3){dis_flag_3=1;};
  44   2          }
  45   1        
  46   1      }
  47          
  48          
  49          void cruise_pattern(){
  50   1          if( AngleNew>0&&AngleNew<120){
  51   2                      P0=0x0F;
  52   2                      P1=0xFF;
  53   2              }
  54   1          else if(AngleNew>120&&AngleNew<240){
C51 COMPILER V9.54   MAIN                                                                  01/08/2016 22:25:18 PAGE 2   

  55   2                      P1=0x0F;
  56   2                      P0=0xFF;
  57   2              }
  58   1          else{
  59   2                  P0=0xFF;
  60   2                  P1=0xFF;
  61   2          }
  62   1      }
  63          
  64          
  65          void UartInit(void)   //115200bps@11.0592MHz
  66          {
  67   1        EA=1;
  68   1        ES=1;
  69   1        SCON = 0x50;
  70   1        RCAP2L = 0xFD;
  71   1        RCAP2H = 0xFF;
  72   1        TL2 = 0xFD;   
  73   1        TH2 = 0xFF;   
  74   1        T2CON=0x34;
  75   1      //以上为T2定时器实现115200波特率
  76   1      }
  77          
  78          
  79          
  80          void ser() interrupt 4
  81          {
  82   1          if(RI)
  83   1          {
  84   2              RI=0;
  85   2              Receive_Buff[counter]=SBUF;
  86   2      
  87   2            if(counter==0&&Receive_Buff[0]!=0x55) return;      //第0号数据不是帧头
  88   2            counter++;
  89   2      
  90   2            if(counter==11)             //接收到11个数据
  91   2              {counter=0;               //重新赋值，准备下一帧数据的接收
  92   3      
  93   3                  switch(Receive_Buff [1])
  94   3                  {
  95   4                  case 0x51:
  96   4                  a[0]=(Receive_Buff[3]<<8|Receive_Buff[2]);
  97   4      //          a[1]=(Receive_Buff[5]<<8|Receive_Buff[4]);
  98   4                  a1=a2;
  99   4                  a2=a3;
 100   4                  a3=a[0];
 101   4                  if(a1>=a2&&a2<=a3){Flag=0;}//固定点判断
 102   4                  if(a1<=a2&&a2>=a3){Flag=1; 
 103   5                  if(w[1]>thres_omega){Dist++;}//一圈里程加1
 104   5                  }
 105   4                  if(Flag==1){AngleNew=asin(a[0]/2048.0)*57.3+90;}//利用x轴加速度方向判断方位角
 106   4                  else{AngleNew=270-asin(a[0]/2048.0)*57.3;}
 107   4      //          a[2]=(Receive_Buff[7]<<8|Receive_Buff[6])/32768.0*16;
 108   4                  break;
 109   4                  
 110   4                  case 0x52:
 111   4                  w[0]=(Receive_Buff[3]<<8|Receive_Buff[2]);
 112   4                  w[1]=(Receive_Buff[5]<<8|Receive_Buff[4]);
 113   4                  w[2]=(Receive_Buff[7]<<8|Receive_Buff[6]);
 114   4                  w1=w2;
 115   4                  w2=w[1];
 116   4      //          w=w[i]/32768.0*2000;
C51 COMPILER V9.54   MAIN                                                                  01/08/2016 22:25:18 PAGE 3   

 117   4                  break;
 118   4                  case 0x53:
 119   4      //            Angle[0]=(Receive_Buff[3]<<8|Receive_Buff[2]);
 120   4      //            Angle[1]=(Receive_Buff[5]<<8|Receive_Buff[4])/32768.0*180;
 121   4      //            Angle[2]=(Receive_Buff[7]<<8|Receive_Buff[6])/32768.0*180;
 122   4                  break;
 123   4                  default: break;
 124   4                  }
 125   3                }
 126   2      
 127   2          }
 128   1          if(TI){TI=0;}
 129   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    844    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =     61    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      4    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
